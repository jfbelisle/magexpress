/**
 * @author zhixin wen <wenzhixin2010@gmail.com>
 * @version 1.1.0
 * Licensed under the MIT license
 *
 * http://wenzhixin.net.cn/p/multiple-select/
 */

(function(c){function k(a,b){var d=this,e=a.attr("name")||b.name||"",h=a.parent().attr("style")||"";a.parent().hide();var f=a.css("width");a.parent().show().attr("style",h);"0px"==f&&(f=a.outerWidth()+20);this.$el=a.hide();this.options=b;this.$parent=c("<div"+c.map(["class","title"],function(a){var b=d.$el.attr(a)||"";return(b=("class"===a?"ms-parent"+(b?" ":""):"")+b)?" "+a+'="'+b+'"':""}).join("")+" />");this.$choice=c('<button type="button" class="ms-choice"><span class="placeholder">'+b.placeholder+
"</span><div></div></button>");this.$drop=c('<div class="ms-drop '+b.position+'"></div>');this.$el.after(this.$parent);this.$parent.append(this.$choice);this.$parent.append(this.$drop);this.$el.prop("disabled")&&this.$choice.addClass("disabled");this.$parent.css("width",b.width||f);this.options.keepOpen||c("body").click(function(a){c(a.target)[0]!==d.$choice[0]&&c(a.target).parents(".ms-choice")[0]!==d.$choice[0]&&(c(a.target)[0]!==d.$drop[0]&&c(a.target).parents(".ms-drop")[0]===d.$drop[0]||!d.options.isOpen||
d.close())});this.selectAllName='name="selectAll'+e+'"';this.selectGroupName='name="selectGroup'+e+'"';this.selectItemName='name="selectItem'+e+'"'}k.prototype={constructor:k,init:function(){var a=this;this.options.filter&&this.$drop.append('<div class="ms-search"><input type="text" autocomplete="off" autocorrect="off" autocapitilize="off" spellcheck="false"></div>');var b=c("<ul></ul>");this.options.selectAll&&!this.options.single&&b.append('<li class="ms-select-all"><label><input type="checkbox" '+
this.selectAllName+" /> "+this.options.selectAllDelimiter[0]+this.options.selectAllText+this.options.selectAllDelimiter[1]+"</label></li>");c.each(this.$el.children(),function(d,c){b.append(a.optionToHtml(d,c))});b.append('<li class="ms-no-results">'+this.options.noMatchesFound+"</li>");this.$drop.append(b);this.$drop.find("ul").css("max-height",this.options.maxHeight+"px");this.$drop.find(".multiple").css("width",this.options.multipleWidth+"px");this.$searchInput=this.$drop.find(".ms-search input");
this.$selectAll=this.$drop.find("input["+this.selectAllName+"]");this.$selectGroups=this.$drop.find("input["+this.selectGroupName+"]");this.$selectItems=this.$drop.find("input["+this.selectItemName+"]:enabled");this.$disableItems=this.$drop.find("input["+this.selectItemName+"]:disabled");this.$noResults=this.$drop.find(".ms-no-results");this.events();this.updateSelectAll(!0);this.update(!0);this.options.isOpen&&this.open()},optionToHtml:function(a,b,d,e){var h=this,f=c(b),m=this.options.multiple;
b=c.map(["class","title"],function(a,b){var d="class"===a&&m,c=f.attr(a)||"";return d||c?" "+a+'="'+(d?"multiple"+(c?" ":""):"")+c+'"':""}).join("");var g,q=this.options.single?"radio":"checkbox";if(f.is("option")){a=f.val();var k=h.options.textTemplate(f),l=f.prop("selected"),n=this.options.styler(a)?' style="'+this.options.styler(a)+'"':"";g=e||f.prop("disabled");""<this.options.blockSeparator&&this.options.blockSeparator==f.val()?l=c("<li"+b+n+">",'<label class="'+this.options.blockSeparator+(g?
"disabled":"")+'">',"</label>","</li>"):(l=c("<li"+b+n+"><label"+(g?' class="disabled"':"")+'><input type="'+q+'" '+this.selectItemName+(l?' checked="checked"':"")+(g?' disabled="disabled"':"")+(d?' data-group="'+d+'"':"")+"/> </label></li>"),l.find("input").val(a));l.find("label").append(document.createTextNode(k));return l}if(!d&&f.is("optgroup")){var p="group_"+a;e=f.attr("label");g=f.prop("disabled");d=c("<div/>");d.append('<li class="group"><label class="optgroup'+(g?" disabled":"")+'" data-group="'+
p+'">'+(this.options.hideOptgroupCheckboxes?"":'<input type="checkbox" '+this.selectGroupName+(g?' disabled="disabled"':"")+" /> ")+e+"</label></li>");l.find("label").append(document.createTextNode(k));c.each(f.children(),function(a,b){d.append(h.optionToHtml(a,b,p,g))});return d.html()}},events:function(){var a=this;this.$choice.off("click").on("click",function(b){b.preventDefault();a[a.options.isOpen?"close":"open"]()}).off("focus").on("focus",this.options.onFocus).off("blur").on("blur",this.options.onBlur);
this.$parent.off("keydown").on("keydown",function(b){switch(b.which){case 27:a.close(),a.$choice.focus()}});this.$searchInput.off("keydown").on("keydown",function(b){9===b.keyCode&&b.shiftKey&&a.close()}).off("keyup").on("keyup",function(b){a.options.filterAcceptOnEnter&&(13===b.which||32==b.which)&&a.$searchInput.val()?(a.$selectAll.click(),a.close(),a.focus()):a.filter()});this.$selectAll.off("click").on("click",function(){var b=c(this).prop("checked"),d=a.$selectItems.filter(":visible");if(d.length===
a.$selectItems.length)a[b?"checkAll":"uncheckAll"]();else a.$selectGroups.prop("checked",b),d.prop("checked",b),a.options[b?"onCheckAll":"onUncheckAll"](),a.update()});this.$selectGroups.off("click").on("click",function(){var b=c(this).parent().attr("data-group"),b=a.$selectItems.filter(":visible").filter('[data-group="'+b+'"]'),d=b.length!==b.filter(":checked").length;b.prop("checked",d);a.updateSelectAll();a.update();a.options.onOptgroupClick({label:c(this).parent().text(),checked:d,children:b.get()})});
this.$selectItems.off("click").on("click",function(){a.updateSelectAll();a.update();a.updateOptGroupSelect();a.options.onClick({label:c(this).parent().text(),value:c(this).val(),checked:c(this).prop("checked")});a.options.single&&a.options.isOpen&&!a.options.keepOpen&&a.close()})},open:function(){if(!this.$choice.hasClass("disabled")){this.options.isOpen=!0;this.$choice.find(">div").addClass("open");this.$drop.show();this.$selectAll.parent().show();this.$noResults.hide();0===this.$el.children().length&&
(this.$selectAll.parent().hide(),this.$noResults.show());if(this.options.container){var a=this.$drop.offset();this.$drop.appendTo(c(this.options.container));this.$drop.offset({top:a.top,left:a.left})}this.options.filter&&(this.$searchInput.val(""),this.$searchInput.focus(),this.filter());this.options.onOpen()}},close:function(){this.options.isOpen=!1;this.$choice.find(">div").removeClass("open");this.$drop.hide();this.options.container&&(this.$parent.append(this.$drop),this.$drop.css({top:"auto",
left:"auto"}));this.options.onClose()},update:function(a){var b=this.getSelects(),d=this.$choice.find(">span");0===b.length?d.addClass("placeholder").html(this.options.placeholder):this.options.countSelected&&b.length<this.options.minimumCountSelected?d.removeClass("placeholder").text((this.options.displayValues?b:this.getSelects("text")).join(this.options.delimiter)):this.options.allSelected&&b.length===this.$selectItems.length+this.$disableItems.length?d.removeClass("placeholder").html(this.options.allSelected):
(this.options.countSelected||this.options.etcaetera)&&b.length>this.options.minimumCountSelected?this.options.etcaetera?d.removeClass("placeholder").text((this.options.displayValues?b:this.getSelects("text").slice(0,this.options.minimumCountSelected)).join(this.options.delimiter)+"..."):d.removeClass("placeholder").html(this.options.countSelected.replace("#",b.length).replace("%",this.$selectItems.length+this.$disableItems.length)):d.removeClass("placeholder").text((this.options.displayValues?b:this.getSelects("text")).join(this.options.delimiter));
this.options.addTitle&&d.prop("title",this.getSelects("text"));this.$el.val(this.getSelects());this.$drop.find("li").removeClass("selected");this.$drop.find("input["+this.selectItemName+"]:checked").each(function(){c(this).parents("li").first().addClass("selected")});a||this.$el.trigger("change")},updateSelectAll:function(a){var b=this.$selectItems;a||(b=b.filter(":visible"));this.$selectAll.prop("checked",b.length&&b.length===b.filter(":checked").length);if(this.$selectAll.prop("checked"))this.options.onCheckAll()},
updateOptGroupSelect:function(){var a=this.$selectItems.filter(":visible");c.each(this.$selectGroups,function(b,d){var e=c(d).parent().attr("data-group"),e=a.filter('[data-group="'+e+'"]');c(d).prop("checked",e.length&&e.length===e.filter(":checked").length)})},getSelects:function(a){var b=this,d=[],e=[];this.$drop.find("input["+this.selectItemName+"]:checked").each(function(){d.push(c(this).parents("li").first().text());e.push(c(this).val())});"text"===a&&this.$selectGroups.length&&(d=[],this.$selectGroups.each(function(){var a=
[],f=c.trim(c(this).parent().text()),e=c(this).parent().data("group"),e=b.$drop.find("["+b.selectItemName+'][data-group="'+e+'"]'),g=e.filter(":checked");if(0!==g.length){a.push("[");a.push(f);if(e.length>g.length){var k=[];g.each(function(){k.push(c(this).parent().text())});a.push(": "+k.join(", "))}a.push("]");d.push(a.join(""))}}));return"text"===a?d:e},setSelects:function(a){var b=this;this.$selectItems.prop("checked",!1);c.each(a,function(a,c){b.$selectItems.filter('[value="'+c+'"]').prop("checked",
!0)});this.$selectAll.prop("checked",this.$selectItems.length===this.$selectItems.filter(":checked").length);this.update()},enable:function(){this.$choice.removeClass("disabled")},disable:function(){this.$choice.addClass("disabled")},checkAll:function(){this.$selectItems.prop("checked",!0);this.$selectGroups.prop("checked",!0);this.$selectAll.prop("checked",!0);this.update();this.options.onCheckAll()},uncheckAll:function(){this.$selectItems.prop("checked",!1);this.$selectGroups.prop("checked",!1);
this.$selectAll.prop("checked",!1);this.update();this.options.onUncheckAll()},focus:function(){this.$choice.focus();this.options.onFocus()},blur:function(){this.$choice.blur();this.options.onBlur()},refresh:function(){this.init()},filter:function(){var a=this,b=c.trim(this.$searchInput.val()).toLowerCase();0===b.length?(this.$selectItems.parent().show(),this.$disableItems.parent().show(),this.$selectGroups.parent().show()):(this.$selectItems.each(function(){var a=c(this).parent();a[0>a.text().toLowerCase().indexOf(b)?
"hide":"show"]()}),this.$disableItems.parent().hide(),this.$selectGroups.each(function(){var b=c(this).parent(),e=b.attr("data-group"),h=a.$selectItems.filter(":visible");b[0===h.filter('[data-group="'+e+'"]').length?"hide":"show"]()}),this.$selectItems.filter(":visible").length?(this.$selectAll.parent().show(),this.$noResults.hide()):(this.$selectAll.parent().hide(),this.$noResults.show()));this.updateOptGroupSelect();this.updateSelectAll()}};c.fn.multipleSelect=function(){var a=arguments[0],b=arguments,
d,e="getSelects setSelects enable disable checkAll uncheckAll focus blur refresh close".split(" ");this.each(function(){var h=c(this),f=h.data("multipleSelect"),m=c.extend({},c.fn.multipleSelect.defaults,h.data(),"object"===typeof a&&a);f||(f=new k(h,m),h.data("multipleSelect",f));if("string"===typeof a){if(0>c.inArray(a,e))throw"Unknown method: "+a;d=f[a](b[1])}else f.init(),b[1]&&(d=f[b[1]].apply(f,[].slice.call(b,2)))});return d?d:this};c.fn.multipleSelect.defaults={name:"",isOpen:!1,placeholder:"",
selectAll:!0,selectAllText:"Select all",selectAllDelimiter:["[","]"],allSelected:"All selected",minimumCountSelected:3,countSelected:"# of % selected",noMatchesFound:"No matches found",multiple:!1,multipleWidth:80,single:!1,filter:!1,width:void 0,maxHeight:250,container:null,position:"bottom",keepOpen:!1,blockSeparator:"",displayValues:!1,delimiter:", ",addTitle:!1,styler:function(){return!1},textTemplate:function(a){return a.text()},onOpen:function(){return!1},onClose:function(){return!1},onCheckAll:function(){return!1},
onUncheckAll:function(){return!1},onFocus:function(){return!1},onBlur:function(){return!1},onOptgroupClick:function(){return!1},onClick:function(){return!1}}})(jQuery);